name: Deploy Selected Proxy (PROD - Approval Required)

on:
  workflow_dispatch:
    inputs:
      proxy_name:
        description: "Enter proxy folder name (example: Reverse-Proxy)"
        required: true
        default: "Reverse-Proxy"

      environment:
        description: "Target Apigee environment"
        required: true
        default: "eval"

jobs:
  branch-protection-check:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure this workflow runs ONLY from prod branch
        run: |
          echo "Triggered from branch: $GITHUB_REF"

          if [[ "$GITHUB_REF" != "refs/heads/prod" ]]; then
            echo "❌ ERROR: Production deployment is only allowed from the 'prod' branch."
            exit 1
          fi

  deploy:
    needs: branch-protection-check
    runs-on: ubuntu-latest
    environment: prod   # ✅ GitHub approval still required

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Install apigeecli
        run: |
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh | bash
          sudo mv apigeecli /usr/local/bin/apigeecli
          apigeecli -v

      - name: Deploy Selected Proxy (PROD After Approval)
        run: |
          TOKEN=$(gcloud auth print-access-token)

          PROXY_NAME="${{ github.event.inputs.proxy_name }}"
          ENV_NAME="${{ github.event.inputs.environment }}"

          echo "✅ Approved for PROD Deploy"
          echo "Deploying Proxy: $PROXY_NAME"
          echo "Target Environment: $ENV_NAME"

          if [ ! -d "apiproxies/$PROXY_NAME/apiproxy" ]; then
            echo "❌ Proxy folder not found: apiproxies/$PROXY_NAME/apiproxy"
            exit 1
          fi

          apigeecli apis create bundle \
            --name "$PROXY_NAME" \
            --proxy-folder "apiproxies/$PROXY_NAME/apiproxy" \
            --org "${{ secrets.APIGEE_ORG }}" \
            --env "$ENV_NAME" \
            --token "$TOKEN" \
            --ovr \
            --wait
