name: Deploy to Eval Environment

on:
  workflow_dispatch:
    inputs:
      proxy_name:
        description: "Enter Proxy Name"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: eval

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ✅ FAIL FAST IF ANY SECRET IS MISSING
      - name: Validate Apigee Secrets
        run: |
          if [ -z "${{ secrets.APIGEE_USERNAME }}" ]; then
            echo "❌ APIGEE_USERNAME secret is MISSING"
            exit 1
          fi

          if [ -z "${{ secrets.APIGEE_PASSWORD }}" ]; then
            echo "❌ APIGEE_PASSWORD secret is MISSING"
            exit 1
          fi

          if [ -z "${{ secrets.APIGEE_ORG }}" ]; then
            echo "❌ APIGEE_ORG secret is MISSING"
            exit 1
          fi

          echo "✅ All Apigee secrets found"

      - name: Set Variables
        run: |
          echo "PROXY_NAME=${{ github.event.inputs.proxy_name }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=eval" >> $GITHUB_ENV

      - name: Display Inputs
        run: |
          echo "Deploying Proxy: $PROXY_NAME"
          echo "Target Environment: $ENVIRONMENT"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Apigee CLI
        run: npm install -g apigeetool

      - name: Deploy Proxy to Apigee (EVAL)
        run: |
          apigeetool deployproxy \
          -u "${{ secrets.APIGEE_USERNAME }}" \
          -p "${{ secrets.APIGEE_PASSWORD }}" \
          -o "${{ secrets.APIGEE_ORG }}" \
          -e "$ENVIRONMENT" \
          -n "$PROXY_NAME" \
          -d "./apiproxy"
