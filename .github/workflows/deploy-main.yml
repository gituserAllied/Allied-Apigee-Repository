name: Deploy to Eval (Main Branch)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Install apigeecli
        run: |
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh | bash
          sudo mv apigeecli /usr/local/bin/apigeecli
          apigeecli -v

      - name: Deploy Proxies to Eval (Auto)
        run: |
          TOKEN=$(gcloud auth print-access-token)

          for dir in apiproxies/*; do
            if [ -d "$dir/apiproxy" ]; then
              PROXY_NAME=$(basename "$dir")

              echo "Deploying $PROXY_NAME to eval..."

              apigeecli apis create bundle \
                --name "$PROXY_NAME" \
                --proxy-folder "$dir/apiproxy" \
                --org "${{ secrets.APIGEE_ORG }}" \
                --env "${{ secrets.APIGEE_ENV }}" \
                --token "$TOKEN" \
                --ovr \
                --wait
            fi
          done
